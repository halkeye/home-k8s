apiVersion: v1
kind: Secret
metadata:
  name: alertmanager-{{ .Release.Name }}-alertmanager
stringData:
  alertmanager.yaml: |
    receivers:
      - name: 'null'
      - name: 'discord'
        discord_configs:
          - webhook_url: {{ .Values.kube-prometheus-stack.alertmanager.config.globals.discord_api_url | quote }}
            send_resolved: true
            title: |-
              {{`[{{ .Status | toUpper }}{{ if eq .Status "firing" }}:{{ .Alerts.Firing | len }}{{ end }}] {{ if ne .CommonAnnotations.summary ""}}{{ .CommonAnnotations.summary }} {{ else if ne .CommonAnnotations.message ""}}{{ .CommonAnnotations.message }} {{ else if ne .CommonAnnotations.description ""}}{{ .CommonAnnotations.description }} {{ else }}{{ .CommonLabels.alertname }}{{ end }}`}}
            message: >-
              {{`{{ range .Alerts -}}`}}
              {{"  **Alert:** {{ .Annotations.title }}{{ if .Labels.severity }} `{{ .Labels.severity }}`{{ end }}"}}
              {{`{{ if ne .Annotations.summary ""}}**Summary:** {{ .Annotations.summary }} {{ else if ne .Annotations.message ""}}**Message:** {{ .Annotations.message }} {{ else if ne .Annotations.description ""}}**Description:** {{ .Annotations.description }}{{ end }}`}}
              {{`  **Details:**`}}
              {{"  {{ range .Labels.SortedPairs }} â€¢ {{ .Name }}: `{{ .Value }}`"}}
              {{`  {{ end }}`}}
              {{`{{ end }}`}}
    route:
      receiver: 'discord'
      routes:
      - receiver: 'null'
        matchers:
        - severity =~ "none"
      - receiver: 'discord'

