apiVersion: monitoring.coreos.com/v1alpha1
kind: AlertmanagerConfig
metadata:
  name: {{ .Release.Name }}-alertmanager-config
spec:
  receivers:
    - name: 'null'
    - name: 'discord'
      slack_configs:
      - channel: '#monitoring'
        icon_url: https://avatars3.githubusercontent.com/u/3380462
        username: 'Prometheus'
        send_resolved: true
        # https://github.com/onedr0p/home-cluster/blob/main/cluster/apps/monitoring/kube-prometheus-stack/helm-release.yaml#L33
        title: |-
          {{`[{{ .Status | toUpper }}{{ if eq .Status "firing" }}:{{ .Alerts.Firing | len }}{{ end }}] {{ if ne .CommonAnnotations.summary ""}}{{ .CommonAnnotations.summary }} {{ else if ne .CommonAnnotations.message ""}}{{ .CommonAnnotations.message }} {{ else if ne .CommonAnnotations.description ""}}{{ .CommonAnnotations.description }} {{ else }}{{ .CommonLabels.alertname }}{{ end }}`}}
        text: >-
          {{`{{ range .Alerts -}}`}}
          {{"  **Alert:** {{ .Annotations.title }}{{ if .Labels.severity }} `{{ .Labels.severity }}`{{ end }}"}}
          {{`{{ if ne .Annotations.summary ""}}**Summary:** {{ .Annotations.summary }} {{ else if ne .Annotations.message ""}}**Message:** {{ .Annotations.message }} {{ else if ne .Annotations.description ""}}**Description:** {{ .Annotations.description }}{{ end }}`}}
          {{`  **Details:**`}}
          {{"  {{ range .Labels.SortedPairs }} â€¢ {{ .Name }}: `{{ .Value }}`"}}
          {{`  {{ end }}`}}
          {{`{{ end }}`}}
  route:
    receiver: 'discord'
    routes:
    - receiver: 'null'
      matchers:
      - severity =~ "none"
    - receiver: 'discord'
