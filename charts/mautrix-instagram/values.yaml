controllers:
  main:
    annotations:
      reloader.stakater.com/auto: "true"
    type: deployment
    replicas: 1
    strategy: Recreate
    initContainers:
      01-init:
        image:
          # probably already downloaded, and includes envsubst
          repository: nginx
          tag: 1.29.0
        env:
          TZ: America/Vancouver
          MAUTRIX_DB_URI:
            valueFrom:
              secretKeyRef:
                name: "mautrix-instagram-db-secret-mautrix-instagram"
                key: POSTGRES_URL
        envFrom:
          - secretRef:
              name: "mautrix-instagram-secret"
        command:
          - bash
          - -c
          - |-
              cat /configmap/config.yaml | envsubst > /data/config.yaml
              find /configmap
              find /data
              cat /data/config.yaml
      gluetun:
        image:
          repository: ghcr.io/qdm12/gluetun
          tag: v3.40.0
        command:
          - sh
          - -c
          - |-
              export WIREGUARD_ENDPOINT_IP=$(LC_ALL=C nslookup $WIREGUARD_ENDPOINT_IP 2>/dev/null  | sed -nr '/Name/,+1s|Address(es)?: *||p')
              exec /gluetun-entrypoint
        env:
          DNS_KEEP_NAMESERVER: true
          DOT: off
          VPN_SERVICE_PROVIDER: custom
          VPN_TYPE: wireguard
        envFrom:
          - secretRef:
              name: "mautrix-instagram-secret"
        probes:
          liveness:
            enabled: true
            custom: true
            spec:
              httpGet:
                path: /
                port: 9999
              timeoutSeconds: 10
              periodSeconds: 30
              failureThreshold: 5
          startup:
            enabled: true
            custom: true
            spec:
              httpGet:
                path: /
                port: 9999
              initialDelaySeconds: 10
              periodSeconds: 10
              failureThreshold: 5
        restartPolicy: Always
        securityContext:
          capabilities:
            add:
              - NET_ADMIN
          allowPrivilegeEscalation: false
          runAsUser: 0
          runAsGroup: 0
          runAsNonRoot: false
    containers:
      main:
        image:
          repository: dock.mau.dev/mautrix/meta
          tag: v0.5.2
        env:
          TZ: America/Vancouver
        command:
          - "/usr/bin/mautrix-meta"
          - "-c"
          - "/data/config.yaml"
        probes:
          liveness:
            enabled: false
            custom: true
            spec:
              httpGet:
                path: /_matrix/mau/live
                port: 29319
              initialDelaySeconds: 0
              periodSeconds: 10
              timeoutSeconds: 1
              failureThreshold: 3
          readiness:
            enabled: false
            custom: true
            spec:
              httpGet:
                path: /_matrix/mau/ready
                port: 29319
              initialDelaySeconds: 0
              periodSeconds: 10
              timeoutSeconds: 1
              failureThreshold: 3
          startup:
            enabled: false
        securityContext:
          allowPrivilegeEscalation: false
          readOnlyRootFilesystem: true
          capabilities:
            drop: ["ALL"]
        resources:
          limits:
            memory: 100Mi
          requests:
            cpu: 10m
            memory: 100Mi
    pod:
      securityContext:
        runAsUser: 1337
        runAsGroup: 1337
        runAsNonRoot: true
        fsGroup: 1337
        fsGroupChangePolicy: OnRootMismatch
service:
  main:
    controller: main
    publishNotReadyAddresses: true
    ports:
      http:
        port: 29319

persistence:
  tmp:
    enabled: true
    type: emptyDir
  data:
    enabled: true
    type: emptyDir
  configmap:
    enabled: true
    type: configMap
    name: "mautrix-instagram-configmap"
