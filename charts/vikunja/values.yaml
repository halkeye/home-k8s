---
# yaml-language-server: $schema=https://raw.githubusercontent.com/bjw-s/helm-charts/common-3.0.1/charts/library/common/values.schema.json
app-template:
  controllers:
    vikunja:
      annotations:
        reloader.stakater.com/auto: "true"
      containers:
        app:
          image:
            repository: vikunja/vikunja
            tag: 0.24.6@sha256:ed1f3ed467fecec0b57e9de7bc6607f8bbcbb23ffced6a81f5dfefc794cdbe3b
          env:
            TZ: America/Vancouver
            VIKUNJA_SERVICE_ENABLEREGISTRATION: false
            VIKUNJA_SERVICE_TIMEZONE: "America/Vancouver"
            VIKUNJA_SERVICE_PUBLICURL: "https://tasks.g4v.dev" 
            VIKUNJA_SERVICE_ENABLEPUBLICTEAMS: true
            VIKUNJA_AUTH_LOCAL: false
            VIKUNJA_METRICS_ENABLED: true
            VIKUNJA_MAILER_ENABLED: true
            VIKUNJA_MAILER_HOST: postfix-mailgun-relay.smtp.svc.cluster.local
            VIKUNJA_MAILER_PORT: 587
            VIKUNJA_MAILER_FROMEMAIL: "vikunja@$g4v.dev"
            VIKUNJA_MAILER_SKIPTLSVERIFY: true
            VIKUNJA_REDIS_ENABLED: true
            VIKUNJA_REDIS_HOST: "{{.Release.Name}}-redis-master:6379"
            VIKUNJA_REDIS_DB: 0
            VIKUNJA_REDIS_PASSWORD:
              valueFrom:
                secretKeyRef:
                  name: "{{ .Release.Name }}-redis"
                  key: redis-password
            VIKUNJA_KEYVALUE_TYPE: "redis"
            # Postgres
            VIKUNJA_DATABASE_TYPE: "postgres"
            VIKUNJA_DATABASE_NAME:
              valueFrom:
                secretKeyRef:
                  name: vikunja-db-secret-vikunja
                  key: LOGIN
            VIKUNJA_DATABASE_USER:
              valueFrom:
                secretKeyRef:
                  name: vikunja-db-secret-vikunja
                  key: LOGIN
            VIKUNJA_DATABASE_PASSWORD:
              valueFrom:
                secretKeyRef:
                  name: vikunja-db-secret-vikunja
                  key: PASSWORD
            VIKUNJA_DATABASE_HOST:
              valueFrom:
                secretKeyRef:
                  name: vikunja-db-secret-vikunja
                  key: HOST
            VIKUNJA_DATABASE_DATABASE:
              valueFrom:
                secretKeyRef:
                  name: vikunja-db-secret-vikunja
                  key: DATABASE_NAME
            VIKUNJA_DATABASE_SSLMODE: "require"
          envFrom:
            - secretRef:
                name: "{{.Release.Name}}-secret"
          resources:
            requests:
              cpu: 50m
              memory: 100Mi
            limits:
              memory: 500Mi
          probes:
            liveness: &probes
              enabled: true
              custom: true
              spec:
                httpGet:
                  path: /api/v1/info
                  port: 3456
                initialDelaySeconds: 0
                periodSeconds: 10
                timeoutSeconds: 1
                failureThreshold: 3
            readiness: *probes
  serviceMonitor:
    app:
      serviceName: app
      endpoints:
        - port: http
          scheme: http
          path: /api/v1/metrics
          interval: 1m
          scrapeTimeout: 10s
          basicAuth:
            username:
              name: "{{.Release.Name}}-secret"
              key: VIKUNJA_METRICS_USERNAME
            password:
              name: "{{.Release.Name}}-secret"
              key: VIKUNJA_METRICS_PASSWORD
  service:
    app:
      controller: vikunja
      ports:
        http:
          port: 3456
  ingress:
    app:
      hosts:
        - host: tasks.g4v.dev
          paths:
            - path: /
              service:
                identifier: app
                port: http
  persistence:
    tmp:
      type: emptyDir
    files:
      enabled: true
      type: persistentVolumeClaim
      accessMode: ReadWriteOnce
      size: 10Gi
      globalMounts:
        - path: /app/vikunja/files
    vikunja-config:
      type: secret
      name: "{{.Release.Name}}-secret"
      globalMounts:
        - path: /app/vikunja/config.yaml
          subPath: config.yaml
          readOnly: true
